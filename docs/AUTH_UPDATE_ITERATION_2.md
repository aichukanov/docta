# Обновление системы авторизации - Итерация 2

## Что добавлено

### 1. Композабл `useAuth()`
Новый композабл для удобной работы с авторизацией в компонентах.

**Файл:** `composables/use-auth.ts`

**Использование:**
```vue
<script setup>
const { isAuthenticated, currentUser, isAdmin, logout } = useAuth();
</script>
```

### 2. Middleware для защиты маршрутов

**`middleware/auth.ts`** - для обычных пользователей
```vue
definePageMeta({
  middleware: 'auth'
})
```

**`middleware/admin-auth.ts`** - обновлен для использования `useAuth()`

### 3. Страница профиля `/profile`

**Файл:** `pages/profile.vue`

**Возможности:**
- Просмотр информации о пользователе
- Управление привязанными OAuth аккаунтами
- Привязка новых способов входа (Google, Telegram)
- Отвязка OAuth аккаунтов
- Выход из системы

### 4. API для управления OAuth аккаунтами

**`GET /api/auth/accounts`**
- Получение списка привязанных аккаунтов

**`POST /api/auth/unlink/:provider`**
- Отвязка OAuth аккаунта (google или telegram)
- Защита: нельзя отвязать единственный способ входа

### 5. Редирект после авторизации

Теперь пользователи автоматически возвращаются на исходную страницу после авторизации:
- При попытке доступа к защищенной странице URL сохраняется
- После успешного входа происходит редирект на сохраненный URL

### 6. Привязка нескольких OAuth провайдеров

**Логика:**
- Если пользователь авторизован → новый OAuth привязывается к текущему аккаунту
- Если не авторизован и email совпадает → привязка к существующему аккаунту
- Если не авторизован и email новый → создание нового пользователя

**Обновленные файлы:**
- `server/api/auth/callback/google.get.ts` - улучшенная логика привязки
- `server/api/auth/google.get.ts` - сохранение redirect URL

## Обновление базы данных

### Проверка существующей структуры

```sql
-- Проверка наличия колонки username
DESCRIBE users;

-- Если колонки username нет, выполните:
ALTER TABLE users ADD COLUMN username VARCHAR(255) NULL AFTER name;
CREATE INDEX idx_users_username ON users(username);
```

### Миграция уже есть
Файл: `server/sql/migrations/add-username-column.sql`

## Тестирование

### 1. Базовая авторизация

```bash
# Запустите dev сервер
npm run dev

# Откройте http://localhost:3000/login
# Попробуйте войти через Google или Telegram
```

### 2. Тест редиректа

1. Перейдите на `/profile` без авторизации
2. Вы будете перенаправлены на `/login`
3. Авторизуйтесь
4. Вы должны вернуться на `/profile`

### 3. Тест привязки аккаунтов

**Сценарий 1: Привязка второго OAuth к существующему аккаунту**
1. Войдите через Google
2. Перейдите на `/profile`
3. Нажмите "Привязать" для Telegram
4. Авторизуйтесь в Telegram
5. Проверьте, что оба аккаунта отображаются в списке

**Сценарий 2: Объединение по email**
1. Выйдите из системы
2. Войдите через Google с email `test@example.com`
3. Выйдите
4. Войдите через Google с тем же email
5. Аккаунт должен быть тот же (проверьте ID в БД)

### 4. Тест отвязки аккаунтов

1. Убедитесь, что у вас привязано 2+ OAuth аккаунта
2. На странице `/profile` нажмите "Отвязать" для одного из них
3. Аккаунт должен быть отвязан
4. Попробуйте отвязать последний аккаунт - должна быть ошибка

### 5. Проверка middleware

**Создайте тестовую страницу:**
```vue
<!-- pages/test-protected.vue -->
<script setup>
definePageMeta({
  middleware: 'auth'
});

const { currentUser } = useAuth();
</script>

<template>
  <div>
    <h1>Защищенная страница</h1>
    <p>Привет, {{ currentUser?.name }}!</p>
  </div>
</template>
```

Без авторизации должен быть редирект на `/login`.

## Проверка линтера

```bash
# Проверка всех новых файлов
npm run lint

# Или конкретных файлов
npx eslint composables/use-auth.ts
npx eslint pages/profile.vue
```

## Возможные проблемы

### 1. Telegram виджет не загружается

**Причина:** Telegram не поддерживает localhost без ngrok

**Решение:**
- Используйте ngrok: `ngrok http 3000`
- Обновите `TELEGRAM_BOT_USERNAME` в `.env` на production бота
- Или создайте отдельного бота для dev

### 2. State mismatch в Google OAuth

**Причина:** Проблемы с cookies

**Решение:**
- Проверьте настройки браузера (разрешены ли cookies)
- В `nuxt.config.ts` проверьте настройки cookies
- Убедитесь, что `x-forwarded-proto` корректный

### 3. Ошибка "Cannot unlink the only authentication method"

**Это корректное поведение!**
- Нельзя отвязать единственный способ входа
- Сначала привяжите другой OAuth провайдер

### 4. Не сохраняется redirect после авторизации

**Проверьте:**
- `sessionStorage` работает в браузере
- Cookies не блокируются
- В консоли нет ошибок JavaScript

## Следующие шаги

### Возможные улучшения для Итерации 3:

1. **Email + пароль авторизация**
   - Форма регистрации
   - Подтверждение email
   - Восстановление пароля

2. **Двухфакторная авторизация (2FA)**
   - TOTP (Google Authenticator)
   - SMS коды
   - Backup коды

3. **История входов**
   - Логирование всех входов
   - IP адреса и user agents
   - Уведомления о новых входах

4. **Управление сессиями**
   - Просмотр активных сессий
   - Logout из конкретных устройств
   - Logout из всех устройств

5. **Улучшения профиля**
   - Редактирование имени
   - Загрузка собственного фото
   - Настройки приватности

## Обратная связь

Если возникли проблемы или есть предложения:
1. Проверьте логи в консоли браузера
2. Проверьте server logs (`npm run dev`)
3. Проверьте логи в БД (таблицы `users`, `oauth_accounts`, `sessions`)

## Документация

Полная документация системы авторизации: `docs/AUTH_SYSTEM.md`

Настройка OAuth провайдеров:
- Google: Смотрите настройки Google Cloud Console
- Telegram: `docs/TELEGRAM_OAUTH_SETUP.md`
