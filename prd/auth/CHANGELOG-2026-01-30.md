# Обновление PRD: Авторизация (30 января 2026)

## Ключевые изменения

### 1. Новый приоритет: Авторизация для админки

**В первую очередь реализуется авторизация для администраторов:**

- ✅ Email + password авторизация
- ✅ Страница входа `/admin/login`
- ✅ Аккаунты создаются вручную в БД (нет открытой регистрации)
- ✅ Middleware для защиты админских роутов

**Затем OAuth для обычных пользователей:**

- OAuth через Google и Telegram
- Блок пользователя в хэдере
- Модальное окно входа

### 2. Структура итераций (было 4, стало 5)

#### Фаза 1: Админка (Приоритет)

| #   | Название                                      | Описание                                           |
| --- | --------------------------------------------- | -------------------------------------------------- |
| 1   | База данных и миграции                        | Таблица users с полями `password_hash`, `is_admin` |
| 2   | **Email/Password авторизация для админов (НОВОЕ)** | Страница `/admin/login`, API, middleware           |

#### Фаза 2: OAuth для пользователей

| #   | Название                          | Описание                                     |
| --- | --------------------------------- | -------------------------------------------- |
| 3   | OAuth через Google (было 2)       | OAuth инфраструктура для обычных пользователей |
| 4   | OAuth через Telegram (было 3)     | Telegram Login Widget                        |
| 5   | UI компоненты (было 4)            | LoginModal, UserMenu, middleware             |

### 3. Изменения в базе данных

**Таблица `users` расширена:**

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255),
    photo_url VARCHAR(500),
    password_hash VARCHAR(255) NULL,    -- НОВОЕ: Для админов
    is_admin BOOLEAN DEFAULT FALSE,     -- НОВОЕ: Флаг администратора
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_email (email),
    INDEX idx_is_admin (is_admin)       -- НОВОЕ: Индекс
);
```

**Важно:**
- `password_hash` NULL для OAuth пользователей
- `password_hash` заполнен для администраторов
- `is_admin=true` только для администраторов

### 4. Создание администраторов

Администраторы создаются **вручную в БД**:

```bash
# 1. Сгенерировать хеш пароля
node -e "const bcrypt = require('bcrypt'); bcrypt.hash('admin123', 10).then(console.log)"

# 2. Вставить в БД
INSERT INTO users (email, name, password_hash, is_admin) VALUES
('admin@docta.me', 'Admin User', 'GENERATED_HASH', TRUE);
```

**Нет открытой регистрации для админов!**

### 5. Обновленные файлы

- `prd/auth/index.md` - обновлен краткий обзор и список итераций
- `prd/auth/01-overview.md` - добавлен контекст про приоритет админки
- `prd/auth/02-requirements.md` - добавлены требования для админской авторизации
- `prd/auth/04-database.md` - обновлена схема БД (добавлены поля password_hash, is_admin)
- `prd/auth/iterations/iteration-01-database.md` - обновлена под новые поля БД
- **`prd/auth/iterations/iteration-02-admin-auth.md`** - НОВАЯ итерация для админской авторизации
- `prd/auth/iterations/iteration-03-oauth-google.md` - переименована из iteration-02
- `prd/auth/iterations/iteration-04-oauth-telegram.md` - переименована из iteration-03
- `prd/auth/iterations/iteration-05-ui-components.md` - переименована из iteration-04
- `prd/auth/iterations/README.md` - обновлена структура итераций
- `prd/auth/PROGRESS.md` - обновлен прогресс (0/5 итераций)

## Что дальше?

### Немедленные действия:

1. **Начать Итерацию 1:** Создать SQL миграции с новыми полями
2. **Начать Итерацию 2:** Реализовать страницу входа для админов

### Порядок разработки:

```
Итерация 1 (БД) 
    ↓
Итерация 2 (Админ авторизация) ← ПРИОРИТЕТ
    ↓
Итерация 3 (OAuth Google)
    ↓
Итерация 4 (OAuth Telegram)
    ↓
Итерация 5 (UI компоненты)
```

## Преимущества нового подхода

1. ✅ **Безопасность:** Закрытая система для админов без возможности самостоятельной регистрации
2. ✅ **Контроль:** Полный контроль над тем, кто имеет административный доступ
3. ✅ **Простота:** Не нужно реализовывать UI для регистрации админов на начальном этапе
4. ✅ **Гибкость:** В будущем можно добавить UI для создания админов в админ панели
5. ✅ **Приоритет:** Сначала делаем то, что нужно для управления контентом

## Вопросы и ответы

**Q: Как создать первого администратора?**  
A: Вручную в БД используя SQL команды (см. раздел "Создание администраторов" выше)

**Q: Можно ли будет позже добавить UI для создания админов?**  
A: Да, это будет добавлено в будущих итерациях этого же PRD

**Q: Чем отличается авторизация админов от OAuth пользователей?**  
A: Админы используют email + password, обычные пользователи - OAuth (Google/Telegram)

**Q: Может ли администратор также иметь OAuth аккаунты?**  
A: Теоретически да, но на начальном этапе не требуется. Админы входят только через `/admin/login`

---

**Дата обновления:** 30 января 2026  
**Автор:** Product Team  
**Статус PRD:** Draft → Updated
