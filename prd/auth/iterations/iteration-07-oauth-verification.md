# Итерация 7: Верификация клиники через OAuth (корпоративные контакты)

[← К списку итераций](README.md) | [← Предыдущая](iteration-06-clinic-crud.md) | [Следующая →](iteration-08-join-requests.md)

---

## Цель

Автоматическая или упрощенная верификация клиники, если пользователь может подтвердить доступ к корпоративным контактам клиники (email, в будущем - телефоны).

## Зависимости

Итерация 6 (создание клиник работает)

## Сценарии использования

### Сценарий 1: Верификация существующей клиники

Пользователь x@x.com зарегистрировался и создал/заявляет права на клинику. Нажимает кнопку OAuth - выбирает корп почту клиники (admin@clinic.com). Если у него есть доступ к корп почте, клиника автоматически верифицируется.

### Сценарий 2: Регистрация с корп email

Пользователь сразу регистрируется под admin@clinic.com. Система автоматически находит клиники с таким email и дает права администратора + автоверификация.

## Задачи

1. Создать таблицу для хранения верификационных OAuth аккаунтов клиник
2. Реализовать проверку email пользователя против контактов клиники
3. Создать API для добавления дополнительного OAuth для верификации
4. Автоматическое предоставление прав при регистрации с корп email
5. UI для процесса верификации через OAuth

## Ключевые технические компоненты

### Утилита: `server/utils/clinic-contact-verification.ts`

**Функции:**

- `checkEmailMatchesClinicContacts()` - проверка совпадения email
- `extractDomain()` - извлечение домена из email
- `isCorporateDomain()` - проверка на корпоративный домен
- `autoVerifyClinicByContact()` - автоматическая верификация

### API Endpoints

- `POST /api/clinics/[id]/verify-via-oauth` - верификация через OAuth
- `GET /api/clinics/[id]/verification-status` - статус верификации контактов

### Компоненты

- `components/clinic/VerifyViaOAuthButton.vue` - кнопка и процесс верификации
- `pages/clinics/[id]/verify-callback.vue` - callback после OAuth

## Критерии приемки

- [ ] AC-1: При создании клиники с email, пользователь видит кнопку "Подтвердить через OAuth"
- [ ] AC-2: При клике на кнопку открывается OAuth flow (Google)
- [ ] AC-3: Если email OAuth совпадает с email клиники - автоматическая верификация
- [ ] AC-4: После верификации создается запись в clinic_verified_contacts
- [ ] AC-5: Флаг is_contact_verified устанавливается в TRUE
- [ ] AC-6: Статус клиники автоматически меняется на 'published'
- [ ] AC-7: Пользователь автоматически получает role='admin' для клиники
- [ ] AC-8: Если пользователь регистрируется с email, совпадающим с клиникой - автоматические права
- [ ] AC-9: Система различает корпоративные и публичные домены
- [ ] AC-10: Все действия логируются в audit_logs
- [ ] AC-11: На странице клиники отображается статус верификации контактов
- [ ] AC-12: Если email не совпадает - показывается соответствующая ошибка

## Как проверить

### Сценарий 1: Верификация существующей клиники

1. Создать клинику с email admin@testclinic.com
2. Открыть /clinics/<id>/edit
3. Увидеть блок "Упрощенная верификация"
4. Нажать "Подтвердить через Google"
5. Войти через Google с email admin@testclinic.com
6. Проверить в БД:
   ```sql
   SELECT * FROM clinic_verified_contacts WHERE clinic_id = <clinic_id>;
   SELECT status, is_contact_verified FROM clinics WHERE id = <clinic_id>;
   SELECT * FROM clinic_users WHERE clinic_id = <clinic_id>;
   ```
7. Статус должен стать 'published', is_contact_verified = TRUE

### Сценарий 2: Регистрация с корп email

1. Создать клинику с email manager@example-clinic.com (пользователь A)
2. Выйти
3. Зарегистрироваться новым пользователем через Google с email manager@example-clinic.com
4. Проверить что новый пользователь автоматически получил role='admin'

### Сценарий 3: Email не совпадает

1. Создать клинику с email info@clinic1.com
2. Попытаться верифицировать через Google с email personal@gmail.com
3. Должна показаться ошибка "Email не совпадает с контактами клиники"

### Сценарий 4: Несколько email у клиники

1. Создать клинику с email: "admin@clinic.com, info@clinic.com, contact@clinic.com"
2. Верифицировать через info@clinic.com - должно работать

## Статус

**Not Started**

---

**Следующая итерация:** [8. Запросы на присоединение →](iteration-08-join-requests.md)
