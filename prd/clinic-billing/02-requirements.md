# 2. Требования: Самостоятельная покупка платных услуг для клиник

[← Назад к оглавлению](index.md)

---

## 2.1 Функциональные требования (FR)

### Доступ к функциональности

- **FR-1:** Администратор клиники должен видеть кнопку "Платные услуги" в профиле своей клиники
- **FR-2:** Кнопка "Платные услуги" должна быть доступна только для авторизованных пользователей с ролью `clinic_admin` для данной клиники
- **FR-3:** При клике на кнопку пользователь переходит на страницу `/profile/clinics/[clinicId]/billing`

### Каталог услуг

- **FR-4:** Страница платных услуг должна отображать все доступные услуги из `billing_paid_services`
- **FR-5:** Для каждой услуги должны отображаться:
  - Название
  - Описание (что дает услуга)
  - Иконка или визуальное представление
  - Цена за период (1 месяц, 3 месяца, 6 месяцев, 12 месяцев)
  - Статус (активна/неактивна для данной клиники)
- **FR-6:** Если услуга уже активна для клиники, должна отображаться дата окончания действия
- **FR-7:** Должна быть возможность фильтрации услуг: "Все", "Активные", "Неактивные"

### Выбор и заказ услуг

- **FR-8:** Администратор может выбрать одну или несколько услуг для покупки
- **FR-9:** Для каждой выбранной услуги можно указать период действия:
  - 1 месяц
  - 3 месяца
  - 6 месяцев
  - 12 месяцев
- **FR-10:** Система должна автоматически рассчитывать итоговую стоимость заказа
- **FR-11:** Должна отображаться скидка при выборе длительных периодов (если применимо)
- **FR-12:** При клике "Купить" создается заказ со статусом `pending_payment`
- **FR-13:** После создания заказа пользователь переходит на страницу подтверждения заказа

### Оплата

- **FR-14:** Страница подтверждения заказа должна отображать:
  - Список выбранных услуг с периодами
  - Итоговую стоимость
  - Информацию о клинике
  - Кнопку "Оплатить"
- **FR-15:** При клике "Оплатить" система должна инициировать процесс оплаты через платежную систему
- **FR-16:** Пользователь перенаправляется на платежную форму (Stripe, PayPal и т.д.)
- **FR-17:** После успешной оплаты пользователь возвращается на страницу успеха `/profile/clinics/[clinicId]/billing/success`
- **FR-18:** При отмене или ошибке оплаты пользователь возвращается на страницу ошибки `/profile/clinics/[clinicId]/billing/error`

### Активация услуг

- **FR-19:** После подтверждения оплаты (через webhook) система должна автоматически:
  - Создать запись в `billing_clinic_service_purchases`
  - Создать записи в `billing_clinic_service_purchase_items` для каждой услуги
  - Установить статус заказа в `completed`
  - Обновить дату `purchased_at` и `valid_until`
- **FR-20:** Услуги должны стать активными немедленно после подтверждения оплаты
- **FR-21:** На публичной странице клиники должны отображаться активированные услуги (бейдж APPROVED, выделение HIGHLIGHT, dofollow ссылки)

### История покупок

- **FR-22:** Страница платных услуг должна содержать секцию "История покупок"
- **FR-23:** История покупок должна отображать:
  - Дату покупки
  - Список услуг
  - Период действия
  - Дату окончания
  - Стоимость
  - Статус (активно/истекло/удалено)
- **FR-24:** Должна быть возможность фильтрации: "Все", "Активные", "Истекшие"
- **FR-25:** Истекшие покупки должны отображаться с визуальным индикатором

### Уведомления

- **FR-26:** После успешной оплаты администратор должен получить email с:
  - Подтверждением оплаты
  - Списком активированных услуг
  - Периодом действия
  - Чеком (receipt)
- **FR-27:** За 7 дней до истечения услуг администратор должен получить email с напоминанием о продлении
- **FR-28:** При истечении услуг администратор должен получить email с предложением продлить

### Безопасность

- **FR-29:** Только администратор клиники может покупать услуги для своей клиники
- **FR-30:** Нельзя покупать услуги для других клиник
- **FR-31:** Все транзакции должны логироваться в `billing_payment_transactions`
- **FR-32:** Webhook от платежной системы должен проверять подпись запроса

---

## 2.2 Нефункциональные требования (NFR)

### Производительность

- **NFR-1:** Страница каталога услуг должна загружаться < 1 секунды
- **NFR-2:** Создание заказа должно выполняться < 500ms
- **NFR-3:** Активация услуг после оплаты должна выполняться < 30 секунд
- **NFR-4:** Webhook должен отвечать < 3 секунды (чтобы платежная система не повторяла запрос)

### Безопасность

- **NFR-5:** Все платежные данные должны обрабатываться через PCI-compliant платежную систему
- **NFR-6:** Платежные данные НЕ должны храниться в нашей базе данных
- **NFR-7:** Webhook endpoint должен проверять подпись платежной системы
- **NFR-8:** Транзакции должны быть идемпотентными (повторный webhook не создает дубликат)
- **NFR-9:** Все API endpoints должны быть защищены middleware проверки прав

### Надежность

- **NFR-10:** При сбое webhook'а оплата не должна теряться (retry механизм)
- **NFR-11:** Если активация не удалась, должна быть возможность retry вручную (через админку)
- **NFR-12:** Система должна логировать все ошибки платежей и активаций

### Масштабируемость

- **NFR-13:** Система должна поддерживать до 1000 одновременных заказов
- **NFR-14:** Webhook endpoint должен обрабатывать до 100 запросов в минуту

### Usability

- **NFR-15:** Интерфейс должен быть адаптивным (мобильная версия)
- **NFR-16:** Все тексты должны быть локализованы (6 языков)
- **NFR-17:** Процесс покупки должен быть понятным без инструкций
- **NFR-18:** Ошибки должны быть понятными и содержать рекомендации по исправлению

### Мониторинг

- **NFR-19:** Все транзакции должны логироваться с уровнем INFO
- **NFR-20:** Ошибки платежей должны логироваться с уровнем ERROR
- **NFR-21:** Должны собираться метрики:
  - Количество созданных заказов
  - Количество успешных платежей
  - Количество отмененных платежей
  - Средняя стоимость заказа
  - Конверсия (просмотры → покупки)

---

## 2.3 Scope (что включено / что НЕ включено)

### ✅ Включено в эту версию

1. **Каталог услуг**

   - Отображение всех услуг из `billing_paid_services`
   - Цены за разные периоды
   - Статус активности для клиники

2. **Покупка услуг**

   - Выбор нескольких услуг
   - Выбор периода действия
   - Создание заказа
   - Расчет стоимости

3. **Онлайн-оплата**

   - Интеграция с платежной системой
   - Редирект на платежную форму
   - Обработка webhook
   - Статусы оплаты

4. **Активация**

   - Автоматическая активация после оплаты
   - Создание записей в БД
   - Обновление публичной страницы

5. **История покупок**

   - Просмотр всех покупок клиники
   - Фильтры: активные/истекшие
   - Детали каждой покупки

6. **Уведомления**
   - Email подтверждение оплаты
   - Email перед истечением срока
   - Email после истечения

### ❌ НЕ включено (out of scope)

1. **Подписки с автопродлением**

   - Автоматическое списание при истечении
   - Будет в v2

2. **Промокоды и скидки**

   - Ввод промокода
   - Применение скидок
   - Будет в v2

3. **Возврат платежей (refunds)**

   - Запрос на возврат
   - Обработка возврата
   - Будет в v2

4. **Пробные периоды (trial)**

   - Бесплатный пробный период
   - Будет в v2

5. **Оплата счетов (invoices)**

   - Генерация счетов
   - Оплата по счету
   - Будет в v2

6. **Корпоративные скидки**

   - Скидки для крупных клиентов
   - Будет в v2

7. **Управление ценами**

   - Изменение цен на услуги
   - Остается только через админку

8. **Аналитика для клиник**
   - Статистика использования услуг
   - Будет в будущих версиях

---

## 2.4 User Stories (детально)

### Epic 1: Просмотр услуг

**US-1.1:** Как администратор клиники, я хочу видеть кнопку "Платные услуги" в меню профиля клиники

**Acceptance Criteria:**

- [ ] Кнопка отображается в боковом меню профиля клиники
- [ ] Кнопка доступна только для роли `clinic_admin`
- [ ] Кнопка имеет иконку и текст "Платные услуги"
- [ ] При клике открывается страница `/profile/clinics/[id]/billing`

**US-1.2:** Как администратор клиники, я хочу видеть все доступные платные услуги

**Acceptance Criteria:**

- [ ] Отображаются все услуги из `billing_paid_services`
- [ ] Для каждой услуги показаны: название, описание, иконка
- [ ] Для каждой услуги показаны цены за 1, 3, 6, 12 месяцев
- [ ] Если услуга активна, показан бейдж "Активна до [дата]"

### Epic 2: Покупка услуг

**US-2.1:** Как администратор клиники, я хочу выбрать несколько услуг для покупки

**Acceptance Criteria:**

- [ ] Можно выбрать чекбоксом несколько услуг
- [ ] Для каждой услуги можно выбрать период (1, 3, 6, 12 месяцев)
- [ ] Показывается итоговая стоимость
- [ ] Кнопка "Купить" активна только если выбрана хотя бы одна услуга

**US-2.2:** Как администратор клиники, я хочу оплатить выбранные услуги онлайн

**Acceptance Criteria:**

- [ ] После клика "Купить" открывается страница подтверждения
- [ ] Страница показывает список услуг и итоговую стоимость
- [ ] При клике "Оплатить" открывается платежная форма
- [ ] После оплаты открывается страница успеха

### Epic 3: История покупок

**US-3.1:** Как администратор клиники, я хочу видеть все мои покупки

**Acceptance Criteria:**

- [ ] На странице платных услуг есть секция "История покупок"
- [ ] Показаны все покупки клиники (активные и истекшие)
- [ ] Для каждой покупки показаны: дата, услуги, период, стоимость
- [ ] Есть фильтры: Все / Активные / Истекшие

---

**Следующая секция:** [3. Архитектура →](03-architecture.md)
