# 5. Риски и метрики: Самостоятельная покупка платных услуг для клиник

[← Назад к оглавлению](index.md)

---

## 5.1 Риски и митигация

| Риск                                        | Вероятность | Влияние   | Митигация                                                                                                            |
| ------------------------------------------- | ----------- | --------- | -------------------------------------------------------------------------------------------------------------------- |
| **Платежная система недоступна**            | Средняя     | Высокое   | • Мониторинг uptime платежной системы<br>• Fallback на другой провайдер<br>• Очередь retry для webhook               |
| **Webhook не доходит**                      | Средняя     | Критичное | • Retry механизм для webhook<br>• Мануальная активация через админку<br>• Логирование всех webhook запросов          |
| **Дубликаты платежей**                      | Низкая      | Высокое   | • Идемпотентность webhook (проверка transaction_id)<br>• Уникальный индекс на transaction_id                         |
| **Неправильный расчет стоимости**           | Низкая      | Среднее   | • Unit тесты для расчета цены<br>• Валидация на backend перед созданием заказа<br>• Сохранение цены на момент заказа |
| **Пользователь покупает для чужой клиники** | Низкая      | Высокое   | • Проверка прав clinic_admin<br>• Middleware на все endpoints<br>• Логирование всех действий                         |
| **Платежная форма долго загружается**       | Средняя     | Среднее   | • Выбор провайдера с быстрой формой<br>• Индикатор загрузки<br>• Таймаут и retry                                     |
| **Услуги не активируются автоматически**    | Низкая      | Высокое   | • Retry механизм для активации<br>• Alert для админа при ошибке<br>• Страница в админке для мануальной активации     |
| **Цены на услуги меняются**                 | Низкая      | Среднее   | • Сохранение цены на момент заказа в order_items<br>• Версионирование цен через флаг active                          |
| **Пользователь закрывает окно оплаты**      | Высокая     | Низкое    | • Сохранение заказа в БД<br>• Возможность вернуться к оплате<br>• Email с ссылкой на незавершенный заказ             |
| **Конкурентная активация**                  | Низкая      | Среднее   | • Транзакции в БД<br>• Проверка статуса заказа перед активацией                                                      |
| **Фрод (мошенничество)**                    | Низкая      | Высокое   | • Логирование IP адресов<br>• Rate limiting на создание заказов<br>• Мониторинг подозрительной активности            |

---

## 5.2 Метрики успеха

### Бизнес метрики

| Метрика                      | Описание                                             | Цель                  | Способ измерения                                         |
| ---------------------------- | ---------------------------------------------------- | --------------------- | -------------------------------------------------------- |
| **Конверсия в покупку**      | % клиник, зашедших на /billing и совершивших покупку | > 10%                 | `(completed_orders / page_views) * 100`                  |
| **Средний чек (AOV)**        | Средняя сумма заказа                                 | Отслеживание роста    | `SUM(total_amount) / COUNT(orders)`                      |
| **Активные платные клиники** | Количество клиник с активными услугами               | Рост на 50% за 3 мес  | `COUNT(DISTINCT clinic_id WHERE valid_until > NOW())`    |
| **Повторные покупки**        | % клиник, совершивших > 1 покупки                    | > 30% за 6 мес        | `COUNT(clinics with purchases > 1) / COUNT(all clinics)` |
| **Revenue**                  | Общий доход от платных услуг                         | Рост на 100% за 3 мес | `SUM(total_amount WHERE status = completed)`             |
| **ARPU**                     | Средний доход с клиники                              | Отслеживание          | `Revenue / COUNT(active_clinics)`                        |

### Технические метрики

| Метрика                 | Описание                                           | Цель            | Способ измерения                                    |
| ----------------------- | -------------------------------------------------- | --------------- | --------------------------------------------------- |
| **Успешность платежей** | % успешных оплат от всех попыток                   | > 95%           | `(success_payments / total_payments) * 100`         |
| **Время оплаты**        | Среднее время от создания заказа до подтверждения  | < 5 мин для p95 | `AVG(completed_at - created_at)`                    |
| **Время активации**     | Среднее время от подтверждения оплаты до активации | < 30 сек        | `AVG(purchase_created_at - transaction_success_at)` |
| **Webhook успешность**  | % успешных webhook запросов                        | > 99%           | `(successful_webhooks / total_webhooks) * 100`      |
| **Webhook latency**     | Время обработки webhook                            | < 3 сек         | `AVG(webhook_processing_time)`                      |
| **API latency**         | Среднее время ответа API endpoints                 | < 500ms         | `AVG(response_time)`                                |
| **Error rate**          | % ошибок в API endpoints                           | < 1%            | `(error_responses / total_requests) * 100`          |

### UX метрики

| Метрика                               | Описание                                               | Цель         | Способ измерения                            |
| ------------------------------------- | ------------------------------------------------------ | ------------ | ------------------------------------------- |
| **Отказы в воронке**                  | % пользователей, начавших заказ и не завершивших       | < 40%        | `(abandoned_orders / started_orders) * 100` |
| **Время на принятие решения**         | Среднее время от просмотра каталога до создания заказа | Отслеживание | `AVG(order_created_at - page_opened_at)`    |
| **Среднее количество услуг в заказе** | Сколько услуг выбирают в среднем                       | > 1.5        | `AVG(COUNT(order_items) GROUP BY order_id)` |
| **Популярность периодов**             | Какие периоды выбирают чаще                            | Отслеживание | `COUNT(order_items GROUP BY months)`        |
| **Возвраты к незавершенным заказам**  | % пользователей, вернувшихся к оплате                  | > 20%        | `(resumed_orders / abandoned_orders) * 100` |

---

## 5.3 Мониторинг и алерты

### Критичные алерты (требуют немедленного реагирования)

1. **Webhook не приходит**

   - **Условие:** Нет успешных webhook за последние 10 минут при наличии pending транзакций
   - **Действие:** Alert в Slack/Email админу, проверить платежную систему

2. **Высокий % неудачных платежей**

   - **Условие:** > 10% платежей failed за последний час
   - **Действие:** Проверить интеграцию, статус платежной системы

3. **Ошибки активации**

   - **Условие:** Ошибка при активации услуг (webhook success, но активация failed)
   - **Действие:** Immediate alert, мануальная проверка и активация

4. **Database errors**
   - **Условие:** Ошибки БД при создании заказа или активации
   - **Действие:** Alert DevOps, проверить состояние БД

### Важные алерты (требуют реагирования в течение дня)

5. **Низкая конверсия**

   - **Условие:** Конверсия < 5% за последние 7 дней
   - **Действие:** Проверить UX, цены, техническое состояние

6. **Высокий % отказов в воронке**

   - **Условие:** > 60% отказов за последние 7 дней
   - **Действие:** Анализ воронки, A/B тесты

7. **Долгая обработка платежей**
   - **Условие:** p95 времени оплаты > 10 минут
   - **Действие:** Проверить интеграцию с платежной системой

### Информационные алерты

8. **Еженедельный отчет**
   - Revenue за неделю
   - Количество новых покупок
   - Топ популярных услуг
   - Средний чек

---

## 5.4 Dashboard для мониторинга

### Основные графики

1. **Revenue Over Time**

   - График дохода по дням/неделям/месяцам
   - Сравнение с прошлым периодом

2. **Orders Funnel**

   - Воронка: Page Views → Started Order → Completed Payment → Activated
   - Показывает, где теряются пользователи

3. **Payment Success Rate**

   - % успешных платежей по дням
   - Разбивка по платежным провайдерам

4. **Average Order Value**

   - Средний чек по времени
   - Разбивка по количеству услуг

5. **Active Services Distribution**

   - Сколько клиник используют каждую услугу
   - Pie chart

6. **Webhook Performance**
   - Latency webhook'ов
   - Количество retry

### Таблицы

7. **Recent Orders**

   - Последние 50 заказов с статусами
   - Быстрый доступ для проверки

8. **Failed Payments**

   - Список неудачных платежей с причинами
   - Возможность retry

9. **Top Clinics by Revenue**
   - Клиники, принесшие больше всего дохода
   - Для анализа поведения

---

## 5.5 A/B тесты (для будущего)

### Эксперименты для оптимизации конверсии

1. **Ценообразование**

   - Тест разных уровней скидок на длительные периоды
   - Тест бандлов (пакетов услуг)

2. **UI/UX**

   - Разный дизайн карточек услуг
   - Позиция кнопки "Купить"
   - Одностраничный checkout vs многостраничный

3. **Мотивация**

   - Отображение "Популярно" бейджа
   - Социальное доказательство ("100+ клиник используют")
   - Urgency ("Скидка действует до...")

4. **Коммуникация**
   - Разные тексты описаний услуг
   - Email напоминания (timing, content)

---

## 5.6 Вопросы для уточнения

- [ ] **Платежная система:** Какой провайдер предпочтительнее: Stripe, PayPal или локальный?
- [ ] **Валюта:** Только EUR или поддержка нескольких валют?
- [ ] **Налоги:** Нужно ли учитывать НДС/VAT?
- [ ] **Возвраты:** Когда планируется добавить функциональность refunds?
- [ ] **Промокоды:** Приоритет на добавление в v2?
- [ ] **Email провайдер:** Какой сервис используется для отправки email?
- [ ] **Мониторинг:** Есть ли предпочтительная система мониторинга (Grafana, DataDog, etc)?
- [ ] **Compliance:** Нужна ли PCI DSS сертификация (обычно покрывается платежным провайдером)?

---

**Следующая секция:** [Итерации разработки →](iterations/README.md)
