# 2. Требования

[← Назад к оглавлению](index.md) | [← Предыдущая: Обзор](01-overview.md)

---

## Функциональные требования (FR)

### FR-1: Удаление runtimeConfig

**Приоритет:** P0 (критично)

- Удалить секцию `runtimeConfig.public` из `nuxt.config.ts`
- Убедиться, что приложение работает без этой секции

**Критерии приемки:**

- ✅ В `nuxt.config.ts` нет секции `runtimeConfig.public`
- ✅ Приложение запускается без ошибок
- ✅ Все переменные доступны через `process.env`

---

### FR-2: Миграция server-side кода

**Приоритет:** P0 (критично)

Заменить `useRuntimeConfig()` на `process.env` в серверных файлах:

1. **server/common/db-mysql.ts** - доступ к DB_HOST, DB_USER, DB_PASSWORD
2. **server/utils/email.ts** - если используется runtimeConfig
3. Любые другие server utils

**Критерии приемки:**

- ✅ Ни один серверный файл не использует `useRuntimeConfig()`
- ✅ Все серверные файлы используют `process.env` напрямую
- ✅ Подключение к БД работает корректно
- ✅ Email отправка работает корректно (если используется)

---

### FR-3: Миграция client-side кода

**Приоритет:** P0 (критично)

Заменить `useRuntimeConfig()` на `process.env` в клиентских файлах:

1. **composables/use-analytics.ts** - MIXPANEL_TOKEN, CLOUDFLARE_TOKEN
2. **components/TelegramLoginButton.vue** - TELEGRAM_BOT_USERNAME (если используется)

**Критерии приемки:**

- ✅ Ни один клиентский файл не использует `useRuntimeConfig()`
- ✅ Все клиентские файлы используют `process.env` напрямую
- ✅ Mixpanel инициализируется корректно
- ✅ Cloudflare инициализируется корректно
- ✅ Telegram login работает корректно

---

### FR-4: Типизация переменных окружения

**Приоритет:** P1 (высокий)

Создать TypeScript типы для всех используемых переменных окружения.

**Критерии приемки:**

- ✅ Создан файл `types/env.d.ts` с интерфейсом `ProcessEnv`
- ✅ TypeScript автокомплит работает для `process.env.*`
- ✅ Нет TypeScript ошибок при использовании `process.env`
- ✅ Все используемые переменные типизированы

**Пример:**

```typescript
// types/env.d.ts
declare global {
	namespace NodeJS {
		interface ProcessEnv {
			// Database
			DB_HOST: string;
			DB_USER: string;
			DB_PASSWORD: string;

			// Analytics
			MIXPANEL_TOKEN?: string;
			CLOUDFLARE_TOKEN?: string;

			// OAuth
			TELEGRAM_BOT_USERNAME?: string;

			// ... остальные переменные
		}
	}
}

export {};
```

---

### FR-5: Валидация обязательных переменных

**Приоритет:** P1 (высокий)

Создать утилиту для валидации обязательных переменных окружения при старте приложения.

**Критерии приемки:**

- ✅ Создана утилита `server/utils/validate-env.ts`
- ✅ Утилита вызывается при старте приложения
- ✅ Приложение не запускается, если отсутствуют обязательные переменные
- ✅ Ясные сообщения об ошибках при отсутствии переменных

**Пример:**

```typescript
// server/utils/validate-env.ts
export function validateEnv() {
	const required = ['DB_HOST', 'DB_USER', 'DB_PASSWORD'];

	const missing = required.filter((key) => !process.env[key]);

	if (missing.length > 0) {
		throw new Error(`Missing required env variables: ${missing.join(', ')}`);
	}
}
```

---

### FR-6: Обновление документации

**Приоритет:** P1 (высокий)

Обновить всю документацию, упоминающую `runtimeConfig`.

**Критерии приемки:**

- ✅ Обновлен README.md (если упоминается runtimeConfig)
- ✅ Обновлены все файлы в `docs/` с упоминанием runtimeConfig
- ✅ Обновлены PRD документы с примерами кода
- ✅ Создан migration guide для команды

---

## Нефункциональные требования (NFR)

### NFR-1: Обратная совместимость

- Все переменные окружения должны остаться с теми же именами
- Значения переменных не должны меняться
- `.env.example` должен остаться актуальным

### NFR-2: Производительность

- Миграция не должна влиять на производительность приложения
- Доступ к `process.env` должен быть таким же быстрым, как и раньше

### NFR-3: Безопасность

- Приватные переменные (пароли, токены) НЕ должны попадать в client bundle
- Использование `process.env` в клиентском коде должно быть ограничено только публичными переменными
- В production build должны попадать только используемые переменные

**Важно:** В Nuxt 3 переменные с префиксом `NUXT_PUBLIC_` автоматически попадают в клиентский bundle. Для приватных переменных префикс не используется.

### NFR-4: Тестируемость

- Все изменения должны быть покрыты мануальным тестированием
- Должна быть возможность легко откатить изменения

### NFR-5: Поддерживаемость

- Код должен быть проще для понимания новыми разработчиками
- Должна быть документация о том, как работать с env переменными

---

## Out of Scope

### Что НЕ делаем

- ❌ **Не меняем имена переменных** - все остается как есть
- ❌ **Не добавляем новые переменные** - только миграция существующих
- ❌ **Не меняем логику** - только способ доступа к переменным
- ❌ **Не затрагиваем деплой** - процесс деплоя остается прежним
- ❌ **Не используем config файлы** - только env переменные

---

## Зависимости

### От каких компонентов зависит

- ✅ Nuxt 3 - встроенная поддержка dotenv
- ✅ TypeScript - для типизации

### На что влияет

- ⚠️ Все места использования `useRuntimeConfig()`
- ⚠️ `nuxt.config.ts` - удаление секции
- ⚠️ Документация - обновление примеров

---

## Критерии успеха

### Технические

1. ✅ 0 использований `useRuntimeConfig()` в кодовой базе
2. ✅ 0 секций `runtimeConfig.public` в `nuxt.config.ts`
3. ✅ Все 5 файлов мигрированы
4. ✅ Приложение запускается без ошибок
5. ✅ Все функции работают как раньше

### Качественные

1. ✅ Код проще для понимания
2. ✅ Меньше дублирования
3. ✅ Понятная документация
4. ✅ Команда понимает, как работать с env

---

[← Назад к оглавлению](index.md) | [← Предыдущая: Обзор](01-overview.md) | [Далее: Архитектура →](03-architecture.md)
