# 4. Риски и метрики

[← Назад к оглавлению](index.md) | [← Предыдущая: Архитектура](03-architecture.md)

---

## Риски

### Высокие риски

#### Риск 1: Приватные переменные в client bundle

**Вероятность:** Средняя  
**Влияние:** Критичное

**Описание:**  
Если забыть про префикс `NUXT_PUBLIC_` и попытаться использовать приватные переменные (например, пароли БД) в клиентском коде, они могут попасть в bundle.

**Митигация:**

- ✅ Четко разделить публичные и приватные переменные в документации
- ✅ Code review - проверять использование env в client-side коде
- ✅ Использовать префикс `NUXT_PUBLIC_` только для публичных переменных
- ✅ Проверять production bundle на наличие секретов

**План действий при возникновении:**

1. Немедленно откатить изменения
2. Пересобрать production bundle
3. Проверить, не утекли ли секреты
4. Исправить код и задеплоить

---

#### Риск 2: Поломка функциональности после миграции

**Вероятность:** Средняя  
**Влияние:** Высокое

**Описание:**  
После замены `useRuntimeConfig()` на `process.env` может сломаться функциональность (например, подключение к БД, аналитика, OAuth).

**Митигация:**

- ✅ Тщательное тестирование каждого изменения
- ✅ Миграция по файлам, а не все сразу
- ✅ Проверка работы в dev и production окружении
- ✅ Откат через git revert при проблемах

**План действий при возникновении:**

1. Определить, какая функция сломалась
2. Проверить, правильно ли названа переменная
3. Проверить, есть ли переменная в .env
4. Если не помогло - откатить изменения
5. Исправить проблему и повторить миграцию

---

### Средние риски

#### Риск 3: Опечатки в именах переменных

**Вероятность:** Средняя  
**Влияние:** Среднее

**Описание:**  
При замене `config.public.mixpanelToken` на `process.env.MIXPANEL_TOKEN` можно допустить опечатку в имени переменной.

**Митигация:**

- ✅ TypeScript типизация - IDE подскажет правильное имя
- ✅ Валидация обязательных переменных при старте
- ✅ Тщательный code review
- ✅ Тестирование каждого изменения

---

#### Риск 4: Забыть обновить документацию

**Вероятность:** Средняя  
**Влияние:** Низкое

**Описание:**  
После миграции в документах могут остаться устаревшие примеры с `useRuntimeConfig()`.

**Митигация:**

- ✅ Поиск по кодовой базе `useRuntimeConfig` в документации
- ✅ Обновление всех найденных упоминаний
- ✅ Создание migration guide для команды

---

### Низкие риски

#### Риск 5: Конфликт с существующим кодом

**Вероятность:** Низкая  
**Влияние:** Низкое

**Описание:**  
Кто-то из команды может параллельно работать над кодом, использующим `useRuntimeConfig()`.

**Митигация:**

- ✅ Координация с командой
- ✅ Миграция в отдельной ветке
- ✅ Быстрая миграция (1-2 дня)

---

## Метрики успеха

### Технические метрики

#### 1. Покрытие миграции

**Цель:** 100% файлов мигрировано

```
Прогресс миграции = (Мигрированных файлов / Всего файлов) × 100%
Цель: 5/5 файлов = 100%
```

**Измерение:**

```bash
# Проверить, остались ли использования useRuntimeConfig
grep -r "useRuntimeConfig" --include="*.ts" --include="*.vue" .
# Результат должен быть: 0 совпадений
```

---

#### 2. Удаление runtimeConfig из конфига

**Цель:** 0 секций runtimeConfig.public в nuxt.config.ts

**Измерение:**

```bash
grep -A 10 "runtimeConfig" nuxt.config.ts
# Результат должен быть: нет совпадений
```

---

#### 3. Отсутствие ошибок TypeScript

**Цель:** 0 ошибок типизации после миграции

**Измерение:**

```bash
npm run type-check
# Результат: All files match the configuration.
```

---

#### 4. Работоспособность приложения

**Цель:** Все функции работают как раньше

**Измерение:**

- [ ] Приложение запускается без ошибок
- [ ] Подключение к БД работает
- [ ] Аналитика инициализируется (Mixpanel, Cloudflare)
- [ ] OAuth авторизация работает (Google, Telegram, Facebook)
- [ ] Email отправка работает

---

### Качественные метрики

#### 1. Упрощение кодовой базы

**Цель:** Меньше когнитивной нагрузки для разработчиков

**До:**

```typescript
// Нужно помнить, что используем runtimeConfig
const config = useRuntimeConfig();
const token = config.public.mixpanelToken;
```

**После:**

```typescript
// Стандартный подход Node.js
const token = process.env.MIXPANEL_TOKEN;
```

**Измерение:**

- Опрос команды: "Стало ли проще работать с env переменными?"
- Количество вопросов в чате: "Как получить env переменную?"

---

#### 2. Скорость онбординга новых разработчиков

**Цель:** Новый разработчик быстрее понимает, как работать с env

**До:**

- Нужно объяснять разницу между `runtimeConfig` и `process.env`
- Нужно объяснять, когда что использовать
- Нужно объяснять, зачем дублирование в `nuxt.config.ts`

**После:**

- "Используй `process.env.VARIABLE_NAME`" - всё!

**Измерение:**

- Время до первого commit нового разработчика

---

#### 3. Количество багов, связанных с env

**Цель:** Меньше багов из-за неправильного использования env

**Измерение:**

- Количество багов в Jira/GitHub с тегом "env" или "config"
- Количество вопросов в чате про env переменные

---

## Мониторинг

### Что мониторим после миграции

#### 1. Логи приложения

Следим за ошибками, связанными с env переменными:

- `undefined variable`
- `Missing env variable`
- `Cannot read property of undefined`

#### 2. Подключение к БД

Проверяем, что подключение к БД работает:

- Логи успешного подключения
- Отсутствие ошибок подключения

#### 3. Аналитика

Проверяем, что аналитика инициализируется:

- Mixpanel events приходят в dashboard
- Cloudflare analytics работает

#### 4. OAuth

Проверяем, что OAuth провайдеры работают:

- Google OAuth - можно войти
- Telegram OAuth - можно войти
- Facebook OAuth - можно войти

---

## Acceptance Criteria (общие)

### Критерии приемки всего PRD

- ✅ Все 5 файлов мигрированы с `useRuntimeConfig()` на `process.env`
- ✅ Секция `runtimeConfig.public` удалена из `nuxt.config.ts`
- ✅ Создан файл `types/env.d.ts` с типами
- ✅ Создана утилита `server/utils/validate-env.ts`
- ✅ Приложение запускается без ошибок
- ✅ Все функции работают как раньше:
  - Подключение к БД
  - Аналитика (Mixpanel, Cloudflare)
  - OAuth (Google, Telegram, Facebook)
  - Email отправка
- ✅ Нет TypeScript ошибок
- ✅ Документация обновлена
- ✅ Создан migration guide для команды
- ✅ Code review пройден
- ✅ Протестировано в dev и production окружении

---

## Checklist финальной проверки

Перед завершением всего PRD:

### Код

- [ ] Выполнен поиск `useRuntimeConfig` - нет совпадений
- [ ] Выполнен поиск `runtimeConfig` в `nuxt.config.ts` - нет совпадений
- [ ] TypeScript компилируется без ошибок
- [ ] ESLint не показывает ошибок
- [ ] Все импорты актуальны

### Функциональность

- [ ] Dev сервер запускается без ошибок
- [ ] Production build создается без ошибок
- [ ] Подключение к БД работает
- [ ] Mixpanel инициализируется
- [ ] Cloudflare инициализируется
- [ ] Google OAuth работает
- [ ] Telegram OAuth работает
- [ ] Facebook OAuth работает
- [ ] Email отправка работает

### Документация

- [ ] Обновлен README.md (если нужно)
- [ ] Обновлены docs/ файлы
- [ ] Создан ENV_MIGRATION.md guide
- [ ] Обновлен .env.example (если нужно)
- [ ] Обновлены PRD документы с примерами кода

### Безопасность

- [ ] Приватные переменные НЕ имеют префикс `NUXT_PUBLIC_`
- [ ] Публичные переменные ИМЕЮТ префикс `NUXT_PUBLIC_`
- [ ] Production bundle не содержит секретов
- [ ] .env НЕ закоммичен в git

### Команда

- [ ] Code review завершен
- [ ] Команда проинформирована о миграции
- [ ] Migration guide разослан команде
- [ ] Ответы на вопросы команды даны

---

[← Назад к оглавлению](index.md) | [← Предыдущая: Архитектура](03-architecture.md)
